<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hokkaido Trip 2026</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const errorBox = document.getElementById('global-error-box');
            if (errorBox) {
                errorBox.style.display = 'block';
                errorBox.innerHTML += `Error: ${msg}<br>Line: ${line}<br><hr>`;
            }
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ==========================================
        //  STEP 1: Firebase 初始化配置
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCRu1WwJpE6UtVJxEPQARX7jJY8UoO0fXQ",
            authDomain: "hokkaido-planner-8e2f9.firebaseapp.com",
            databaseURL: "https://hokkaido-planner-8e2f9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hokkaido-planner-8e2f9",
            storageBucket: "hokkaido-planner-8e2f9.firebasestorage.app",
            messagingSenderId: "988921508830",
            appId: "1:988921508830:web:0065bd5d25a6686044234f",
            measurementId: "G-RR71QBNFB1"
        };

        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        let auth, googleProvider, database;
        if (typeof firebase !== 'undefined') {
            auth = firebase.auth();
            database = firebase.database(); 
            googleProvider = new firebase.auth.GoogleAuthProvider();
            auth.useDeviceLanguage(); 
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'taro-purple': '#F3E5F5', 'deep-sea-blue': '#006064', 'accent-yellow': '#FFD740' },
                    boxShadow: { 'soft': '0 4px 20px rgba(0,0,0,0.05)', 'card': '0 2px 5px rgba(0, 0, 0, 0.05)' }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=M+PLUS+Rounded+1c:wght@500;800&display=swap');
        body { background-color: #fff; -webkit-tap-highlight-color: transparent; font-family: 'M PLUS Rounded 1c', 'Noto Sans TC', sans-serif; color: #374151; margin: 0; }
        .app-container { max-width: 480px; width: 100%; margin: 0 auto; min-height: 100dvh; background-color: #F3E5F5; position: relative; padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; z-index: 1000; background-color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .auth-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://raw.githubusercontent.com/bio990212/123/main/Gemini_Generated_Image_41wkeu41wkeu41wk.png'); background-size: cover; background-position: center; filter: blur(8px) brightness(0.7); transform: scale(1.1); }
        .auth-content { position: relative; z-index: 10; width: 85%; max-width: 320px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-radius: 2rem; padding: 2rem 1.5rem; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.5); }
        .header-bg { background-color: #F3E5F5; padding: 0; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; height: 280px; }
        .header-image-container { width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: center; display: block; filter: brightness(0.9); }
        .snow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1.5" fill="%23fff" opacity="0.9"/><circle cx="20" cy="80" r="1" fill="%23fff" opacity="0.7"/><circle cx="70" cy="30" r="2" fill="%23fff" opacity="0.8"/></svg>'); background-size: 120px 120px; opacity: 0.8; animation: snowfall 15s linear infinite; z-index: 15; pointer-events: none; }
        @keyframes snowfall { to { background-position: 120px 120px; } }
        .side-tab-bar { position: absolute; bottom: 20px; right: 16px; z-index: 30; display: flex; flex-direction: row; gap: 8px; }
        .tab-button { width: 50px; height: 50px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); border: 2px solid #fff; background: white; color: #94a3b8; }
        .tab-button span { font-size: 9px; font-weight: 800; margin-top: 1px; }
        .tab-button i { font-size: 18px; }
        .tab-button.active { transform: translateY(-5px) scale(1.05); color: #ffffff; border-color: transparent; }
        .modern-input { width: 100%; background-color: #F8FAFC; padding: 12px; border-radius: 14px; border: 1px solid #E2E8F0; font-weight: 700; color: #475569; outline: none; font-size: 16px; transition: all 0.2s ease; box-sizing: border-box; }
        .modern-input:focus { background-color: #fff; border-color: currentColor; ring: 2px; }
        .modern-label { display: block; font-size: 12px; color: #64748B; font-weight: 800; margin-bottom: 4px; margin-left: 2px; }
        .flight-input-group { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; padding: 8px; transition: all 0.2s; }
        .flight-input-group:focus-within { background: #fff; }
        .fab-btn { position: fixed; right: 1.5rem; bottom: calc(1.5rem + env(safe-area-inset-bottom)); z-index: 40; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(255,255,255,0.4); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.6); }
        .ios-modal { position: fixed; inset: 0; z-index: 100; background-color: #F8FAFC; display: flex; flex-direction: column; }
        .ios-modal-header { flex: none; background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #E2E8F0; padding: 1rem; padding-top: max(1rem, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .ios-modal-body { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: calc(2rem + env(safe-area-inset-bottom)); }
        
        .loading-overlay { position: fixed; inset: 0; background: #F3E5F5; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .debug-box { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: lime; font-family: monospace; font-size: 10px; padding: 5px; z-index: 9999; max-height: 100px; overflow-y: auto; pointer-events: none; }
        #global-error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; background: red; color: white; padding: 20px; z-index: 10000; font-family: monospace; }
    </style>
</head>
<body>

<div id="global-error-box"></div>

<div id="app" class="app-container">
    
    <div class="debug-box" v-if="debugMsg && debugMsg.length > 0">
        <div v-for="(msg, i) in debugMsg" :key="i">> {{ msg }}</div>
    </div>

    <div v-if="isAuthChecking" class="loading-overlay">
        <div class="w-12 h-12 border-4 border-[#006064] border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold text-[#006064]">正在確認身分與同步資料...</p>
    </div>

    <div id="auth-container" v-if="!isLoggedIn && !isAuthChecking"> 
        <div class="auth-bg"></div>
        <div class="auth-content animate-fade-in">
            <div class="w-16 h-16 bg-[#006064] rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg text-white text-3xl">
                <i class="fa-solid fa-plane-departure"></i>
            </div>
            
            <div class="mb-6">
                <h3 id="user-info" class="text-sm font-bold text-slate-500 mb-1">{{ statusMessage }}</h3> 
                <h1 class="text-2xl font-black text-slate-800 tracking-wide">Hokkaido 2026</h1>
            </div>
            
            <p class="text-xs text-slate-500 font-bold mb-6">請點擊下方按鈕以開始使用線上編輯功能。</p>
            
            <button @click="handleLogin('google')" class="w-full bg-white text-slate-600 font-bold py-3.5 px-4 rounded-xl shadow-md border border-slate-200 flex items-center justify-center gap-3 active:scale-95 transition-transform mb-3">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                <span>使用 Google 帳號登入 (Popup)</span>
            </button>

            <button @click="handleLogin('guest')" class="w-full bg-slate-100 text-slate-500 font-bold py-3 px-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-center gap-2 active:scale-95 transition-transform text-sm">
                <i class="fa-solid fa-user-secret"></i>
                <span>訪客登入 (不需驗證)</span>
            </button>
        </div>
    </div>

    <div id="app-content" class="w-full h-full" v-if="isLoggedIn"> 
        <div class="header-bg relative">
            <div class="header-image-container">
                <img src="https://raw.githubusercontent.com/bio990212/123/main/Gemini_Generated_Image_41wkeu41wkeu41wk.png" alt="Sapporo TV Tower Snow"> 
            </div>
            <div class="snow-layer"></div> 
            <div class="absolute top-4 right-4 z-20">
                <button @click="handleLogout" class="bg-black/30 backdrop-blur-md text-white px-3 py-1.5 rounded-full text-xs font-bold border border-white/30 flex items-center gap-1 active:scale-95 transition-transform shadow-lg"> 
                    <i class="fa-solid fa-right-from-bracket"></i> <span>登出</span>
                </button>
            </div> 
            <div class="side-tab-bar">
                <button @click="currentTab = 'itinerary'" :class="['tab-button', currentTab === 'itinerary' ? 'active bg-[#006064] shadow-lg shadow-cyan-900/30' : '']"><i class="fa-solid fa-map-location-dot"></i><span>行程</span></button>
                <button @click="currentTab = 'info'" :class="['tab-button', currentTab === 'info' ? 'active bg-[#5E35B1] shadow-lg shadow-purple-900/30' : '']"><i class="fa-solid fa-circle-info"></i><span>資訊</span></button>
                <button @click="currentTab = 'shopping'" :class="['tab-button', currentTab === 'shopping' ? 'active bg-[#D81B60] shadow-lg shadow-pink-900/30' : '']"><i class="fa-solid fa-basket-shopping"></i><span>購物</span></button>
                <button @click="currentTab = 'expenses'" :class="['tab-button', currentTab === 'expenses' ? 'active bg-[#F57F17] shadow-lg shadow-orange-900/30' : '']"><i class="fa-solid fa-coins"></i><span>花費</span></button>
            </div>
        </div>

        <main class="p-3">
            <div v-if="currentTab === 'itinerary'" class="animate-fade-in pb-20">
                <div class="bg-gradient-to-br from-[#00BCD4] to-[#006064] rounded-3xl p-4 text-white shadow-soft relative overflow-hidden mb-4 mt-1">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-center relative z-10">
                        <div class="flex items-center gap-3">
                             <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/30 shadow-inner"><i :class="weatherData.icon" class="text-2xl drop-shadow-md"></i></div>
                             <div>
                                 <div class="flex items-baseline gap-2"><span class="text-3xl font-black tracking-tighter drop-shadow-sm">{{ weatherData.temp }}°</span><span class="text-sm font-bold opacity-90">{{ weatherData.desc }}</span></div>
                                 <div class="text-xs opacity-90 flex items-center gap-2 font-medium"><span class="bg-black/10 px-2 py-0.5 rounded-full backdrop-blur-sm"><i class="fa-solid fa-location-dot mr-1"></i>{{ weatherData.location }}</span></div>
                             </div>
                        </div>
                        <div class="flex flex-col gap-2">
                             <button @click="fetchWeather(43.06, 141.35, '札幌')" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 active:scale-95 transition-all border border-white/20"><i class="fa-solid fa-tree-city text-xs"></i></button>
                             <button @click="locateUser" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 active:scale-95 transition-all border border-white/20"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                    </div>
                </div>
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 pb-2 mb-2 sticky top-0 bg-taro-purple/95 backdrop-blur-sm z-20 py-2 -mx-3 px-3">
                    <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index" class="snap-center flex-shrink-0 w-[56px] h-[64px] rounded-xl flex flex-col items-center justify-center border-2 transition-all duration-300" :class="selectedDateIndex === index ? 'bg-[#006064] text-white border-[#006064] shadow-md scale-105' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'">
                        <span class="text-sm font-black uppercase">{{ day.weekday }}</span> <span class="text-[10px] font-bold mt-0.5 opacity-90">{{ day.display }}</span> 
                    </div>
                </div>
                <div class="timeline-container pt-2">
                    <div v-if="!itineraryData[selectedDateIndex] || itineraryData[selectedDateIndex].length === 0" class="text-center py-10 text-slate-400">
                         <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-3 border-2 border-slate-200 border-dashed"><i class="fa-solid fa-map-location-dot text-2xl opacity-30 text-slate-400"></i></div>
                         <p class="text-base font-bold">本日尚無行程</p>
                    </div>
                    <div v-for="(item, idx) in itineraryData[selectedDateIndex]" :key="item.id" class="relative pb-4">
                        <div class="flex gap-2 relative group">
                            <div class="w-[45px] shrink-0 text-right pt-[1.6rem]">
                                <div class="font-mono font-black text-[#006064] text-lg leading-none tracking-tight">{{ item.startTime }}</div>
                                <div v-if="item.endTime" class="text-[10px] text-slate-400 font-mono mt-1 font-bold">{{ item.endTime }}</div>
                            </div>
                            <div class="w-[20px] shrink-0 relative flex flex-col items-center">
                                <div class="absolute top-0 bottom-0 left-1/2 -translate-x-1/2 w-0 border-l-2 border-dashed border-slate-300 z-0"></div>
                                <div class="absolute top-[1.8rem] w-3 h-3 bg-gray-400 rounded-full border-2 border-white z-10 shadow-sm"></div>
                                <div v-if="idx > 0 && item.transport" @click.stop="openSmartNavigation(idx)" class="absolute -top-5 z-10 w-7 h-7 rounded-full bg-white border-[2px] border-[#00BCD4] flex items-center justify-center shadow-md cursor-pointer hover:scale-110 active:scale-95 transition-all"><i :class="getTransportIcon(item.transport)" class="text-[10px] text-[#006064]"></i></div>
                            </div>
                            <div class="flex-1 bg-white rounded-2xl p-4 border-2 border-slate-300 shadow-soft relative overflow-hidden z-10">
                                <div class="absolute top-3 right-3 z-20">
                                    <button @click.stop="editItinerary(idx)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:text-white hover:bg-[#006064] flex items-center justify-center transition-all active:scale-90 shadow-sm border border-slate-200"><i class="fa-solid fa-pen text-[10px]"></i></button>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <div><span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-black text-white shadow-sm ring-1 ring-white" :style="{backgroundColor: getCategoryColor(item.category)}"><i :class="getCategoryIcon(item.category)" class="mr-1.5 text-xs"></i>{{ categories.find(c=>c.id===item.category)?.name || '行程' }}</span></div>
                                    <h3 class="text-lg font-black text-slate-800 tracking-wide leading-snug pr-8">{{ item.name }}</h3>
                                    <div v-if="item.address || item.location" class="flex items-center flex-wrap gap-2">
                                        <div class="flex-1 min-w-0"><div class="text-xs text-slate-500 font-bold truncate flex items-center"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>{{ item.address || item.location }}</div></div>
                                        <button v-if="item.address" @click.stop="openMapLink(item.address, '')" class="bg-cyan-50 text-cyan-700 px-2 py-1 rounded-lg text-[10px] font-black border border-cyan-100 active:scale-95 flex items-center gap-1 hover:bg-cyan-100 transition-colors shadow-sm flex-shrink-0"><i class="fa-solid fa-map"></i> 地圖</button>
                                    </div>
                                    <div class="flex flex-wrap gap-2 text-xs text-slate-600 font-bold">
                                        <span v-if="item.cost" class="flex items-center bg-slate-50 px-2 py-1 rounded-lg border border-slate-200"><i class="fa-solid fa-ticket mr-1.5 text-slate-400"></i>{{ item.cost }}</span>
                                        <span v-if="item.openHours" class="flex items-center bg-slate-50 px-2 py-1 rounded-lg border border-slate-200"><i class="fa-regular fa-clock mr-1.5 text-slate-400"></i>{{ item.openHours }}</span>
                                    </div>
                                    <p v-if="item.note" class="text-xs text-slate-600 bg-[#F1F5F9] p-3 rounded-xl border-l-[4px] border-slate-300 leading-relaxed font-medium mt-1">{{ item.note }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'shopping'" class="animate-fade-in grid grid-cols-2 gap-3 pt-4 pb-20 mt-2">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-2xl p-2 card-shadow relative group border-2 border-slate-300">
                    <div class="aspect-square bg-slate-50 rounded-xl mb-2 border-2 border-slate-200 overflow-hidden relative">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-[#F8BBD0] text-4xl opacity-30 font-bold"><i class="fa-solid fa-camera"></i></div>
                        <button @click.stop="editShop(idx)" class="absolute top-2 right-2 bg-white/80 text-slate-600 rounded-full w-8 h-8 flex items-center justify-center shadow-sm backdrop-blur-sm z-10 active:scale-90 transition-transform"><i class="fa-solid fa-pen text-sm"></i></button>
                    </div>
                    <p class="font-black text-sm text-slate-700 truncate px-1 text-center pb-1">{{ item.name }}</p>
                </div>
                <div v-if="!shoppingList.length" class="col-span-2 text-center py-20 text-slate-300 font-bold"><div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-slate-300 border-dashed"><i class="fa-solid fa-basket-shopping text-4xl text-[#F8BBD0]"></i></div><p class="font-black text-lg text-slate-400">購物清單空白</p></div>
            </div>

            <div v-if="currentTab === 'info'" class="space-y-4 animate-fade-in pb-20 mt-2">
                
                <div class="bg-white rounded-3xl p-4 card-shadow border border-slate-200">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center border border-yellow-100"><i class="fa-solid fa-file-pen text-sm"></i></div>
                        <h3 class="font-black text-lg text-slate-800">共同筆記</h3>
                        <span v-if="isAuthorized" class="text-[10px] text-white bg-green-500 px-2 py-0.5 rounded-full ml-2">管理者模式 (全功能同步)</span>
                        <span v-else class="text-[10px] text-white bg-gray-400 px-2 py-0.5 rounded-full ml-2">本地模式 (僅本機儲存)</span>
                        
                        <span v-if="isUpdatingFromCloud" class="text-xs text-green-500 font-bold ml-auto animate-pulse">同步中...</span>
                    </div>
                    <textarea 
                        v-model="sharedNote"
                        class="w-full h-40 bg-slate-50 rounded-xl p-3 border border-slate-200 text-sm font-bold text-slate-600 focus:bg-white focus:ring-2 focus:ring-yellow-200 outline-none transition-all resize-none leading-relaxed"
                        :placeholder="isAuthorized ? '在此輸入文字，將會即時同步給所有人...' : '您目前的權限僅能進行本地暫存...'">
                    </textarea>
                </div>

                <div class="bg-gradient-to-r from-[#5E35B1] to-[#7E57C2] rounded-3xl p-4 text-white shadow-soft relative overflow-hidden font-bold">
                    <div class="flex justify-between items-center mb-4 relative z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center shadow-inner-light border border-white/20"><i class="fa-solid fa-calculator text-lg"></i></div>
                            <h3 class="font-black text-lg tracking-wide">匯率換算</h3>
                        </div>
                        <button @click="showRateEditModal = true" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 active:scale-90 transition-transform"><i class="fa-solid fa-pencil text-xs"></i></button>
                    </div>
                    <div class="flex items-center justify-between gap-3 relative z-10">
                        <div class="flex-1 bg-white/10 rounded-2xl p-3 border border-white/10 backdrop-blur-md text-center"><label class="text-[10px] text-white/80 block mb-1 font-bold">{{ rateDirection ? 'JPY' : 'TWD' }}</label><input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-transparent text-center text-white font-black text-xl outline-none placeholder-white/30" placeholder="0"></div>
                        <button @click="toggleRateDirection" class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-white/20 rounded-full active:rotate-180 transition-all shadow-md border border-white/20"><i class="fa-solid fa-arrow-right-arrow-left text-white text-xs"></i></button>
                        <div class="flex-1 bg-white/10 rounded-2xl p-3 border border-white/10 backdrop-blur-md text-center"><label class="text-[10px] text-white/80 block mb-1 font-bold">{{ rateDirection ? 'TWD' : 'JPY' }}</label><div class="text-center font-black text-xl text-accent-yellow">{{ currencyResult.toLocaleString() }}</div></div>
                    </div>
                    <div class="text-[10px] text-white/60 mt-3 text-center tracking-widest font-medium bg-black/20 py-1 rounded-full w-fit mx-auto px-4">1 : {{ currentRate }}</div>
                </div>

                <div class="bg-white rounded-3xl p-4 card-shadow border border-slate-200">
                    <div class="flex justify-between items-center mb-4"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center border border-purple-100"><i class="fa-solid fa-plane-departure text-sm"></i></div><h3 class="font-black text-lg text-slate-800">航班</h3></div><button @click="showFlightEditModal = true" class="text-xs text-white font-bold bg-[#5E35B1] px-3 py-1.5 rounded-xl active:scale-95 transition-all shadow-sm">新增/修改</button></div>
                    <div class="space-y-4">
                        <div v-for="(f, i) in flights" :key="i" class="relative bg-white rounded-2xl border-2 border-slate-300 shadow-sm overflow-hidden group">
                            <div class="bg-slate-50/80 px-4 py-2 flex justify-between items-center border-b border-slate-200"><span class="text-xs font-bold text-slate-500 tracking-wide flex items-center gap-1"><i class="fa-regular fa-calendar-check text-purple-400"></i> {{ f.depDate ? f.depDate.slice(5).replace('-','/') : '未定' }}</span><span class="text-[10px] font-black text-white bg-[#5E35B1] px-2 py-0.5 rounded shadow-sm">{{ f.airline }}</span></div>
                            <div class="p-4">
                                <div class="flex justify-between items-center mb-3"><div class="text-center w-1/3"><div class="text-2xl font-black text-slate-800 tracking-tighter">{{ f.from }}</div><div class="text-xs text-slate-500 font-bold">{{ f.fromName }}</div><div class="text-[10px] font-bold text-purple-600 mt-0.5 bg-purple-50 inline-block px-1.5 py-0.5 rounded">T{{f.depTerminal}}</div></div><div class="flex-1 flex flex-col items-center px-1"><div class="text-[10px] text-slate-400 font-black tracking-widest mb-0.5">{{ f.code }}</div><div class="w-full h-0.5 bg-slate-300 relative my-1"><i class="fa-solid fa-plane text-slate-300 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white px-1 text-sm"></i></div></div><div class="text-center w-1/3"><div class="text-2xl font-black text-slate-800 tracking-tighter">{{ f.to }}</div><div class="text-xs text-slate-500 font-bold">{{ f.toName }}</div><div class="text-[10px] font-bold text-purple-600 mt-0.5 bg-purple-50 inline-block px-1.5 py-0.5 rounded">T{{f.arrTerminal}}</div></div></div>
                                <div class="flex justify-between items-center bg-slate-50 rounded-xl p-2 px-4 border border-slate-200"><div class="text-center"><span class="block text-[10px] text-slate-400 font-bold mb-0.5 uppercase">起飛</span><span class="font-mono font-black text-slate-800 text-lg">{{ f.depTime }}</span></div><div class="h-6 w-px bg-slate-300"></div><div class="text-center"><span class="block text-[10px] text-slate-400 font-bold mb-0.5 uppercase">抵達</span><span class="font-mono font-black text-slate-800 text-lg">{{ f.arrTime }}</span></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-4 card-shadow border border-slate-200">
                    <div class="flex justify-between items-center mb-4"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center border border-purple-100"><i class="fa-solid fa-hotel text-sm"></i></div><h3 class="font-black text-lg text-slate-800">住宿</h3></div><button @click="showHotelEditModal = true" class="text-xs text-white font-bold bg-[#5E35B1] px-3 py-1.5 rounded-xl active:scale-95 transition-all shadow-sm">新增/修改</button></div>
                    <ul class="space-y-4">
                        <li v-for="(h, i) in hotels" :key="i" class="bg-white border-2 border-slate-300 rounded-2xl p-4 shadow-sm">
                            <div class="flex justify-between items-start mb-3"><div><h4 class="font-black text-lg text-slate-800 leading-snug mb-1">{{ h.name }}</h4><div class="flex items-center gap-2 flex-wrap"><span class="text-[10px] font-bold text-white bg-[#5E35B1] px-2 py-0.5 rounded shadow-sm">{{ calculateNights(h.checkInDate, h.checkOutDate) }} 晚</span><span class="text-[10px] text-slate-500 tracking-wide font-bold bg-slate-100 px-2 py-0.5 rounded border border-slate-200"><i class="fa-regular fa-calendar mr-1"></i>{{ formatDateDisplay(h.checkInDate, h.checkOutDate) }}</span></div></div><div class="flex flex-col gap-1.5"><button @click="openMapLink(h.name, h.mapUrl)" class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center shadow-sm active:scale-90 transition-all hover:bg-purple-100 border border-purple-100"><i class="fa-solid fa-map-location-dot text-sm"></i></button><button @click="openNavigation(h.name)" class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center shadow-sm active:scale-90 transition-all hover:bg-emerald-100 border border-emerald-100"><i class="fa-solid fa-diamond-turn-right text-sm"></i></button></div></div>
                            <div class="grid grid-cols-2 gap-2 text-center"><div class="bg-slate-50 rounded-xl p-2 border border-slate-200"><span class="block text-[10px] text-slate-400 font-bold mb-0.5">入住時間</span><span class="font-black text-slate-700 font-mono text-base">{{ h.checkInTime || '--:--' }}</span></div><div class="bg-slate-50 rounded-xl p-2 border border-slate-200"><span class="block text-[10px] text-slate-400 font-bold mb-0.5">退房時間</span><span class="font-black text-slate-700 font-mono text-base">{{ h.checkOutTime || '--:--' }}</span></div></div>
                        </li>
                    </ul>
                </div>

                <div class="bg-white rounded-3xl p-4 border-2 border-purple-100 shadow-sm animate-fade-in font-bold">
                    <div class="flex items-center gap-3 mb-4"><div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center border border-red-200"><i class="fa-solid fa-triangle-exclamation text-sm"></i></div><h3 class="font-black text-lg text-slate-800">緊急求助</h3></div>
                    <div class="grid grid-cols-2 gap-3"><a href="tel:110" class="group bg-red-50 py-4 rounded-2xl border-2 border-red-100 shadow-sm active:bg-red-600 active:border-red-600 transition-all flex flex-col items-center justify-center"><i class="fa-solid fa-user-shield text-2xl text-red-500 mb-1 group-active:text-white transition-colors"></i><span class="text-red-700 font-black text-lg group-active:text-white transition-colors">110 警察</span></a><a href="tel:119" class="group bg-red-50 py-4 rounded-2xl border-2 border-red-100 shadow-sm active:bg-red-600 active:border-red-600 transition-all flex flex-col items-center justify-center"><i class="fa-solid fa-truck-medical text-2xl text-red-500 mb-1 group-active:text-white transition-colors"></i><span class="text-red-700 font-black text-lg group-active:text-white transition-colors">119 救護</span></a></div>
                </div>
            </div>

            <div v-if="currentTab === 'expenses'" class="animate-fade-in space-y-6 pb-20 mt-2">
                <div class="relative rounded-3xl p-5 text-white shadow-2xl overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-[#F57F17] via-[#F9A825] to-[#FFB300] opacity-95"></div>
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white rounded-full blur-[80px] opacity-20"></div>
                    <div class="relative z-10 font-bold">
                        <div class="flex justify-between items-center mb-5 border-b border-white/20 pb-3"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center border border-white/20"><i class="fa-solid fa-coins text-white text-lg"></i></div><h3 class="font-black text-lg tracking-wide">旅費統計</h3></div></div>
                        <div class="text-center mb-6"><span class="text-xs text-yellow-50 block tracking-[0.2em] mb-2 font-bold opacity-80 uppercase">{{ totalExpenses.label }}</span><div class="text-4xl font-mono block tracking-tight font-black drop-shadow-lg"><span class="text-2xl mr-1 opacity-80">{{ totalExpenses.currency === 'JPY' ? '¥' : '$' }}</span>{{ totalExpenses.amount.toLocaleString() }}</div></div>
                        <div class="glass-panel rounded-2xl p-3 flex justify-between items-center shadow-inner"><button @click="toggleRateDirection" class="bg-white text-[#F57F17] px-4 py-2 rounded-xl font-bold active:scale-95 transition-all flex items-center tracking-wider font-bold text-xs shadow-md"><i class="fa-solid fa-rotate mr-2"></i> {{ rateDirection ? 'JPY ➔ TWD' : 'TWD ➔ JPY' }}</button><div class="flex items-center space-x-2 pr-1"><span class="text-xs opacity-70 tracking-wide font-bold">匯率</span><input type="number" step="0.001" v-model="currentRate" class="w-16 bg-transparent text-right font-black outline-none border-b-2 border-white/30 text-lg focus:border-white transition-colors"></div></div>
                    </div>
                </div>
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 pb-2 mb-2 sticky date-selector-sticky pt-2 -mx-3 px-3 bg-taro-purple/95 backdrop-blur-sm z-20"><div v-for="(day, index) in expenseDates" :key="index" @click="selectedExpenseIndex = index" class="snap-center flex-shrink-0 w-[56px] h-[64px] rounded-xl flex flex-col items-center justify-center border-2 transition-all duration-300" :class="selectedExpenseIndex === index ? 'bg-[#F57F17] text-white border-[#F57F17] shadow-lg scale-105' : 'bg-white text-slate-400 border-slate-300'"><span class="text-sm font-black uppercase">{{ day.weekday }}</span> <span class="text-xs font-bold mt-0.5 opacity-80">{{ day.display }}</span> </div></div>
                <div class="pb-20">
                    <div class="bg-white rounded-3xl p-4 card-shadow border-2 border-slate-300 relative">
                        <div class="flex justify-between items-center border-b-2 border-slate-200 pb-3 mb-3"><div class="flex items-center space-x-2"><div class="bg-[#F57F17] text-white font-black px-2.5 py-1 rounded-lg text-xs shadow-sm">{{ expenseDates[selectedExpenseIndex].display }}</div><span class="text-xs text-slate-400 font-bold tracking-widest">{{ expenseDates[selectedExpenseIndex].weekday }}</span></div><div class="text-right"><span class="text-[10px] text-slate-400 block tracking-widest mb-0.5 uppercase font-bold">本日總計</span><span class="text-lg font-mono font-black text-[#F57F17]">{{ getDailyTotal(expenseDates[selectedExpenseIndex].full) }}</span></div></div>
                        <div v-if="getDailyExpenses(expenseDates[selectedExpenseIndex].full).length > 0" class="space-y-3">
                            <div v-for="(ex, i) in getDailyExpenses(expenseDates[selectedExpenseIndex].full)" :key="i" class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border-2 border-slate-300 relative group overflow-hidden">
                                 <button @click="editExpense(ex)" class="absolute top-2 right-2 text-slate-400 hover:text-[#F57F17] transition-colors w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-100 z-20"><i class="fa-solid fa-pen text-sm"></i></button>
                                 <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg mr-3 shadow-sm flex-shrink-0 border-2 border-white" :style="{backgroundColor: getCategoryColor(ex.category)}"><i :class="getCategoryIcon(ex.category)"></i></div>
                                <div class="flex-1 flex flex-col justify-center pr-6"><div class="flex items-center justify-between mb-1"><span class="font-bold text-slate-700 text-sm tracking-wide">{{ ex.title }}</span></div><div class="flex items-center space-x-1.5 text-[10px] text-slate-500 font-bold flex-wrap gap-y-1"><span class="bg-white px-2 py-0.5 rounded border border-slate-200 flex items-center gap-1 shadow-sm"><i :class="ex.method === 'Card' ? 'fa-solid fa-credit-card text-blue-400' : 'fa-solid fa-money-bill-1 text-green-500'" class="text-[10px]"></i> {{ ex.method === 'Card' ? '刷' : '現' }}</span><span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded border border-orange-200">付:{{ ex.payer }}</span><span v-if="ex.expenseType === 'personal'" class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded border border-blue-200">個人</span><span v-else-if="ex.expenseType === 'advanced'" class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded border border-purple-200">代墊</span></div></div>
                                <div class="text-right flex-shrink-0 ml-1 pr-10"><span class="block font-black font-mono text-base" :class="ex.currency === 'JPY' ? 'text-blue-600' : 'text-green-600'">{{ ex.currency === 'JPY' ? '¥' : '$' }} {{ Number(ex.amount).toLocaleString() }}</span></div>
                            </div>
                        </div>
                        <div v-else class="text-center py-10 text-slate-300 font-bold"><p class="tracking-widest text-sm">本日尚無紀錄</p></div>
                    </div>
                </div>
            </div>

            <button v-if="currentTab === 'itinerary'" @click="addItineraryItem" class="fab-btn w-14 h-14 bg-[#006064] text-white rounded-full shadow-xl shadow-cyan-800/40 flex items-center justify-center active:scale-90 transition-all border-4 border-white"><i class="fa-solid fa-plus text-white text-2xl font-bold"></i></button>
            <button v-if="currentTab === 'shopping'" @click="openShopModal()" class="fab-btn w-14 h-14 bg-[#D81B60] text-white rounded-full shadow-xl shadow-pink-800/40 flex items-center justify-center active:scale-90 transition-all border-4 border-white"><i class="fa-solid fa-plus text-white text-2xl font-bold"></i></button>
            <button v-if="currentTab === 'expenses'" @click="openExpenseModal()" class="fab-btn w-14 h-14 bg-[#F57F17] text-white rounded-full shadow-xl shadow-orange-800/40 flex items-center justify-center active:scale-90 transition-all border-4 border-white"><i class="fa-solid fa-plus text-white text-2xl font-bold"></i></button>

            <div v-if="showExpenseModal" class="ios-modal animate-fade-in"><div class="ios-modal-header text-[#F57F17]"><button @click="showExpenseModal = false" class="text-slate-500 font-bold px-2">取消</button><h3 class="font-black text-lg tracking-wider text-slate-800">{{ editingExpenseIdx > -1 ? '編輯' : '新增' }}</h3><button @click="saveExpense" class="font-bold px-2">儲存</button></div><div class="ios-modal-body p-4 flex flex-col gap-3"><div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-200"><button @click="expenseForm.method='Cash'" :class="expenseForm.method==='Cash' ? 'bg-[#F57F17] text-white shadow' : 'text-slate-400'" class="flex-1 rounded-lg font-bold text-sm transition-all py-2.5"><i class="fa-solid fa-money-bill-1 mr-1"></i>現金</button><button @click="expenseForm.method='Card'" :class="expenseForm.method==='Card' ? 'bg-[#2979FF] text-white shadow' : 'text-slate-400'" class="flex-1 rounded-lg font-bold text-sm transition-all py-2.5"><i class="fa-solid fa-credit-card mr-1"></i>刷卡</button></div><div class="flex gap-3 items-center"><div class="flex-[2]"><label class="modern-label">金額</label><input type="number" v-model="expenseForm.amount" placeholder="0" class="modern-input h-12 text-2xl font-black text-right"></div><div class="flex-1"><label class="modern-label">幣別</label><select v-model="expenseForm.currency" class="modern-input h-12 text-center font-bold"><option value="JPY">JPY</option><option value="TWD">TWD</option></select></div></div><div><label class="modern-label">項目</label><input v-model="expenseForm.title" placeholder="例如: 午餐" class="modern-input h-12 text-base"></div><div><label class="modern-label">分類</label><div class="grid grid-cols-5 gap-2"><button v-for="cat in categories" :key="cat.id" @click="expenseForm.category = cat.id" :class="expenseForm.category === cat.id ? 'ring-2 ring-offset-2 ring-[#F57F17] bg-white' : 'bg-white opacity-60'" class="p-2 rounded-xl flex flex-col items-center justify-center border border-slate-100 aspect-square shadow-sm"><div class="w-7 h-7 rounded-full mb-1 flex items-center justify-center text-white text-xs" :style="{backgroundColor: cat.color}"><i :class="cat.icon"></i></div><span class="text-[10px] font-bold text-slate-600 truncate w-full text-center">{{ cat.name }}</span></button></div></div><div class="flex gap-3"><div class="flex-1"><label class="modern-label">誰付</label><div class="flex gap-1 bg-white p-1 rounded-xl border border-slate-200"><button v-for="m in members" :key="m" @click="expenseForm.payer = m" :class="expenseForm.payer === m ? 'bg-[#F57F17] text-white shadow-sm' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">{{ m }}</button></div></div><div class="flex-[1.5]"><label class="modern-label">類型</label><div class="flex gap-1 bg-white p-1 rounded-xl border border-slate-200"><button @click="expenseForm.expenseType = 'personal'" :class="expenseForm.expenseType === 'personal' ? 'bg-blue-500 text-white shadow-sm' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">個人</button><button @click="expenseForm.expenseType = 'shared'" :class="expenseForm.expenseType === 'shared' ? 'bg-green-500 text-white shadow-sm' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">共同</button><button @click="expenseForm.expenseType = 'advanced'" :class="expenseForm.expenseType === 'advanced' ? 'bg-purple-500 text-white shadow-sm' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">代墊</button></div></div></div><button v-if="editingExpenseIdx > -1" @click="deleteExpense" class="w-full py-3.5 bg-red-50 text-red-500 rounded-xl font-bold mt-auto border border-red-100 text-sm">刪除此紀錄</button></div></div>
            <div v-if="showItineraryModal" class="ios-modal animate-fade-in"><div class="ios-modal-header text-[#006064]"><button @click="showItineraryModal = false" class="text-slate-500 font-bold px-2">取消</button><h3 class="font-black text-lg tracking-wider text-slate-800">{{ editingItineraryIdx > -1 ? '編輯行程' : '新增行程' }}</h3><button @click="saveItinerary" class="font-bold px-2">儲存</button></div><div class="ios-modal-body space-y-4"><div><label class="modern-label">名稱</label><input v-model="itineraryForm.name" class="modern-input h-10 text-base" placeholder="行程名稱"></div><div class="grid grid-cols-2 gap-3"><div><label class="modern-label">開始時間</label><input type="time" v-model="itineraryForm.startTime" @change="calculateEndTime" class="modern-input h-10 text-sm text-center w-full"></div><div><label class="modern-label">停留時間</label><select v-model="itineraryForm.duration" @change="calculateEndTime" class="modern-input h-10 text-sm w-full"><option value="0">不設定</option><option value="30">30 分鐘</option><option value="60">1 小時</option><option value="90">1.5 小時</option><option value="120">2 小時</option><option value="180">3 小時</option><option value="240">4 小時</option></select></div></div><div class="grid grid-cols-2 gap-3"><div><label class="modern-label">分類</label><select v-model="itineraryForm.category" class="modern-input h-10 text-sm w-full"><option value="sightseeing">景點</option><option value="food">餐飲</option><option value="transport">交通</option><option value="shopping">購物</option><option value="hotel">住宿</option><option value="other">其他</option></select></div><div><label class="modern-label">移動方式</label><select v-model="itineraryForm.transport" class="modern-input h-10 text-sm w-full"><option value="">無</option><option value="walk">步行</option><option value="train">JR/火車</option><option value="subway">地鐵</option><option value="bus">巴士</option><option value="car">自駕</option></select></div></div><div><label class="modern-label">Google 地圖連結</label><input v-model="itineraryForm.address" class="modern-input h-10 text-sm" placeholder="貼上網址或輸入地址"></div><div class="grid grid-cols-2 gap-3"><div><label class="modern-label">營業時間</label><input v-model="itineraryForm.openHours" class="modern-input h-10 text-sm" placeholder="09:00-21:00"></div><div><label class="modern-label">預算/門票</label><input v-model="itineraryForm.cost" class="modern-input h-10 text-sm" placeholder="¥1000"></div></div><div><label class="modern-label">備註</label><textarea v-model="itineraryForm.note" class="modern-input h-24 resize-none leading-relaxed text-sm" placeholder="備註事項..."></textarea></div><button v-if="editingItineraryIdx > -1" @click="deleteItinerary" class="w-full py-3.5 bg-red-50 text-red-500 rounded-xl font-bold mt-2 border border-red-100 text-sm">刪除此行程</button></div></div>
            <div v-if="showShopModal" class="ios-modal animate-fade-in"><div class="ios-modal-header text-[#D81B60]"><button @click="showShopModal = false" class="text-slate-500 font-bold px-2">取消</button><h3 class="font-black text-lg tracking-wider text-slate-800">{{ editingShopIdx > -1 ? '編輯' : '新增' }}</h3><button @click="saveShop" class="font-bold px-2">儲存</button></div><div class="ios-modal-body space-y-6"><div class="text-center"><label class="block w-full aspect-square bg-white rounded-3xl border-4 border-dashed border-slate-200 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition-colors relative overflow-hidden group shadow-sm"><img v-if="shopForm.image" :src="shopForm.image" class="absolute inset-0 w-full h-full object-cover"><div v-else class="text-slate-400 flex flex-col items-center group-hover:scale-110 transition-transform"><i class="fa-solid fa-camera text-5xl mb-3 text-pink-200"></i><span class="text-sm font-bold uppercase tracking-widest text-slate-400">點擊拍照</span></div><input type="file" accept="image/*" class="hidden" @change="(e) => uploadImg(e, shopForm)"></label></div><div><label class="modern-label">商品名稱</label><input v-model="shopForm.name" class="modern-input h-10 text-lg" placeholder="例如: 白色戀人"></div><button v-if="editingShopIdx > -1" @click="deleteShop" class="w-full py-3.5 bg-red-50 text-red-500 rounded-xl font-bold mt-4 border border-red-100 text-sm">刪除此商品</button></div></div>
            <div v-if="showRateEditModal" class="ios-modal animate-fade-in"><div class="ios-modal-header text-[#5E35B1]"><button @click="showRateEditModal = false" class="text-slate-500 font-bold px-2">取消</button><h3 class="font-black text-lg tracking-wider text-slate-800">匯率設定</h3><button @click="showRateEditModal = false" class="font-bold px-2">完成</button></div><div class="ios-modal-body space-y-6 flex flex-col items-center justify-center"><div class="w-full bg-white p-6 rounded-3xl shadow-sm border border-slate-100"><div class="flex items-center justify-between mb-6"><span class="font-bold text-slate-600 text-sm tracking-widest">換算方向</span><button @click="toggleRateDirection" class="bg-[#7E57C2] text-white px-6 py-3 rounded-2xl font-bold active:scale-95 transition-transform flex items-center tracking-widest font-bold text-sm shadow-md">{{ rateDirection ? 'JPY ➔ TWD' : 'TWD ➔ JPY' }}</button></div><div class="text-center"><label class="text-xs text-slate-400 block mb-3 font-bold tracking-widest uppercase">今日自定義利率</label><div class="bg-slate-50 rounded-2xl p-6 shadow-inner ring-4 ring-transparent focus-within:ring-purple-100 transition-all"><input type="number" step="0.001" v-model="currentRate" @input="calculateCurrency" class="w-full bg-transparent text-center font-black text-5xl text-[#5E35B1] outline-none border-none tracking-tight"></div></div></div></div></div>
            <div v-if="showFlightEditModal" class="ios-modal animate-fade-in"><div class="ios-modal-header text-[#5E35B1]"><button @click="showFlightEditModal = false" class="text-slate-500 font-bold px-2">關閉</button><h3 class="font-black text-lg tracking-wider text-slate-800">航班管理</h3><button @click="flights.push({})" class="font-bold px-2"><i class="fa-solid fa-plus"></i></button></div><div class="ios-modal-body space-y-6"><div v-for="(f, i) in flights" :key="i" class="bg-white rounded-3xl p-5 border border-slate-200 shadow-sm relative overflow-hidden"><div class="absolute top-0 left-0 w-2 h-full bg-[#5E35B1]"></div><button @click="flights.splice(i,1)" class="absolute top-3 right-3 text-slate-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-100 z-10 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button><div class="mb-4 pl-3 pr-8"><div class="flex gap-4 mb-3"><div class="flight-input-group flex-1"><label class="text-[10px] text-slate-400 block font-bold uppercase">日期</label><input type="date" v-model="f.depDate" class="w-full bg-transparent outline-none text-base font-bold text-slate-700"></div><div class="flight-input-group w-1/3"><label class="text-[10px] text-slate-400 block font-bold uppercase">代號</label><input v-model="f.code" class="w-full bg-transparent outline-none text-base font-black text-slate-700 uppercase" placeholder="CI130"></div></div><div class="flight-input-group"><label class="text-[10px] text-slate-400 block font-bold uppercase">航空公司</label><input v-model="f.airline" class="w-full bg-transparent outline-none text-base font-bold text-slate-700" placeholder="例如: 中華航空"></div></div><div class="bg-slate-50 rounded-2xl p-4 border border-slate-100"><div class="flex items-center justify-between mb-4"><div class="text-center flex-1"><input v-model="f.from" class="w-full text-center bg-transparent font-black text-3xl text-slate-700 uppercase outline-none placeholder-slate-300" placeholder="TPE"><input v-model="f.fromName" class="w-full text-center bg-transparent text-xs text-slate-500 font-bold outline-none" placeholder="桃園"><input v-model="f.depTerminal" class="w-full text-center bg-transparent text-[10px] text-[#5E35B1] font-bold outline-none mt-1 bg-purple-50 py-1 rounded" placeholder="航廈?"></div><div class="px-2 text-slate-300 text-xl"><i class="fa-solid fa-plane"></i></div><div class="text-center flex-1"><input v-model="f.to" class="w-full text-center bg-transparent font-black text-3xl text-slate-700 uppercase outline-none placeholder-slate-300" placeholder="CTS"><input v-model="f.toName" class="w-full text-center bg-transparent text-xs text-slate-500 font-bold outline-none" placeholder="新千歲"><input v-model="f.arrTerminal" class="w-full text-center bg-transparent text-[10px] text-[#5E35B1] font-bold outline-none mt-1 bg-purple-50 py-1 rounded" placeholder="航廈?"></div></div><div class="grid grid-cols-2 gap-4 border-t border-slate-200 pt-3"><div><label class="text-[10px] text-slate-400 block text-center font-bold uppercase mb-1">起飛時間</label><input type="time" v-model="f.depTime" class="w-full text-center bg-white font-black text-base text-slate-700 outline-none rounded-xl h-10 shadow-sm border border-slate-100"></div><div><label class="text-[10px] text-slate-400 block text-center font-bold uppercase mb-1">抵達時間</label><input type="time" v-model="f.arrTime" class="w-full text-center bg-white font-black text-base text-slate-700 outline-none rounded-xl h-10 shadow-sm border border-slate-100"></div></div></div></div><div class="py-8 text-center text-slate-400 text-sm font-bold opacity-50">沒有更多航班了</div></div></div>
            <div v-if="showHotelEditModal" class="ios-modal animate-fade-in"><div class="ios-modal-header text-[#5E35B1]"><button @click="showHotelEditModal = false" class="text-slate-500 font-bold px-2">關閉</button><h3 class="font-black text-lg tracking-wider text-slate-800">住宿管理</h3><button @click="hotels.push({})" class="font-bold px-2"><i class="fa-solid fa-plus"></i></button></div><div class="ios-modal-body space-y-6"><div v-for="(h, i) in hotels" :key="i" class="relative bg-white rounded-3xl p-5 mb-4 border border-slate-200 shadow-sm"><button @click="hotels.splice(i,1)" class="absolute top-3 right-3 text-slate-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-100"><i class="fa-solid fa-xmark text-lg"></i></button><div class="mb-4 pr-8"><label class="modern-label">飯店名稱</label><input v-model="h.name" class="modern-input h-10 text-lg" placeholder="例如: 札幌東急 Stay"></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="modern-label">入住日期</label><input type="date" v-model="h.checkInDate" class="modern-input h-10 text-sm w-full"></div><div><label class="modern-label">退房日期</label><input type="date" v-model="h.checkOutDate" class="modern-input h-10 text-sm w-full"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="modern-label">入住時間</label><input type="time" v-model="h.checkInTime" class="modern-input h-10 text-sm text-center w-full"></div><div><label class="modern-label">退房時間</label><input type="time" v-model="h.checkOutTime" class="modern-input h-10 text-sm text-center w-full"></div></div><div><label class="modern-label">Google 地圖連結</label><input v-model="h.mapUrl" class="modern-input h-10 text-sm" placeholder="http://maps.google.com..."></div></div><div class="py-8 text-center text-slate-400 text-sm font-bold opacity-50">沒有更多住宿了</div></div></div>

        </main>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // AUTH LOGIC
            const isLoggedIn = ref(false);
            const statusMessage = ref('初始化中...');
            const isAuthListenerInitialized = ref(false);
            const userEmail = ref('');
            const isAuthChecking = ref(true); 
            const debugMsg = ref([]); 

            // ============================================
            // 權限管理核心：白名單設定
            // ============================================
            const ALLOWED_EMAILS = [
                'melody910610@gmail.com',
                'd861130t@gmail.com'
            ];

            const isAuthorized = computed(() => {
                return userEmail.value && ALLOWED_EMAILS.includes(userEmail.value);
            });

            const logDebug = (msg) => {
                console.log(`[AppDebug] ${msg}`);
                debugMsg.value.push(msg);
                if(debugMsg.value.length > 5) debugMsg.value.shift();
            };

            const handleLogin = (type) => {
                if (type === 'google' && typeof auth !== 'undefined' && typeof googleProvider !== 'undefined') {
                    statusMessage.value = '正在跳轉至 Google 驗證頁面...';
                    isAuthChecking.value = true;
                    
                    auth.signInWithPopup(googleProvider) 
                        .then((result) => {
                            const user = result.user;
                            isLoggedIn.value = true;
                            userEmail.value = user.email;
                            statusMessage.value = `歡迎, ${user.email}`;
                            isAuthChecking.value = false;
                        })
                        .catch((error) => {
                            console.error("Google 登入錯誤:", error.code, error.message);
                            statusMessage.value = '登入失敗: ' + error.code;
                            isAuthChecking.value = false;
                        });

                } else if (type === 'guest') {
                    statusMessage.value = '正在進入訪客模式...';
                    isAuthChecking.value = true;
                    setTimeout(() => {
                        isLoggedIn.value = true;
                        userEmail.value = 'guest';
                        statusMessage.value = '';
                        isAuthChecking.value = false;
                        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                    }, 800);
                }
            };

            const handleLogout = () => {
                if(confirm('確定要登出嗎？')) {
                    auth.signOut().then(() => {
                         isLoggedIn.value = false;
                         userEmail.value = '';
                         statusMessage.value = '已登出，請重新登入';
                    });
                }
            };
            
            const startAuthListener = () => {
                 if (isAuthListenerInitialized.value) return;
                 isAuthListenerInitialized.value = true;
                 
                 auth.onAuthStateChanged(user => {
                     if (user) {
                         isLoggedIn.value = true;
                         userEmail.value = user.email;
                         statusMessage.value = `歡迎回來, ${user.displayName || user.email}`;
                         isAuthChecking.value = false;
                     } else {
                         isLoggedIn.value = false;
                         userEmail.value = '';
                         statusMessage.value = '請登入';
                         isAuthChecking.value = false;
                     }
                 });
            };

            // ==========================================
            // VUE 邏輯部分 (保持不變)
            // ==========================================
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            const selectedExpenseIndex = ref(0);
            const STORAGE_KEY = 'hokkaido_2026_data_v16'; 

            const currentRate = ref(0.23); 
            const currencyInput = ref('');
            const currencyResult = ref(0);
            const rateDirection = ref(true); 
            const isRateAuto = ref(true);

            const showShopModal = ref(false);
            const showRateEditModal = ref(false);
            const showHotelEditModal = ref(false);
            const showFlightEditModal = ref(false);
            const showExpenseModal = ref(false);
            const showItineraryModal = ref(false);

            const weatherData = ref({ temp: '--', icon: 'fa-solid fa-snowflake', desc: '載入中', location: '札幌', pop: 0 });

            const shoppingList = ref([
                { name: '白色戀人', image: '', bought: false },
                { name: '六花亭草莓巧克力', image: '', bought: false }
            ]);
            const shopForm = ref({ name: '', image: '' });
            const editingShopIdx = ref(-1);

            const expensesList = ref([
                { title: '行前準備', amount: 2000, currency: 'TWD', date: '2025-12-29', category:'other', method:'Cash', payer:'銘銘', expenseType: 'shared' },
                { title: '便利商店', amount: 850, currency: 'JPY', date: '2025-12-30', category:'food', method:'Cash', payer:'銘銘', expenseType: 'personal' }
            ]);
            const expenseForm = ref({ title: '', amount: '', currency: 'JPY', category: 'food', method: 'Cash', payer: '銘銘', expenseType: 'shared' });
            const editingExpenseIdx = ref(-1);

            const itineraryData = ref(Array(7).fill().map(() => [])); 
            const itineraryForm = ref({ startTime: '09:00', duration: '0', endTime: '', name: '', location: '', address: '', note: '', category: 'sightseeing', transport: '', openHours: '', cost: '' });
            const editingItineraryIdx = ref(-1);

            const hotels = ref([{name:'札幌東急 Stay',checkInDate:'2025-12-30',checkOutDate:'2026-01-01',checkInTime:'15:00',checkOutTime:'11:00',mapUrl:''}]);
            const flights = ref([{airline:'中華航空',depDate:'2025-12-30',fromName:'桃園',from:'TPE',toName:'新千歲',to:'CTS',code:'CI130',depTerminal:'2',arrTerminal:'I',depTime:'08:35',arrTime:'13:15'}]);

            const categories = [
                { id: 'food', name: '餐飲', icon: 'fa-solid fa-utensils', color: '#FFAB91' },
                { id: 'transport', name: '交通', icon: 'fa-solid fa-train-subway', color: '#90CAF9' },
                { id: 'hotel', name: '住宿', icon: 'fa-solid fa-hotel', color: '#CE93D8' },
                { id: 'shop', name: '購物', icon: 'fa-solid fa-bag-shopping', color: '#F48FB1' },
                { id: 'fun', name: '娛樂', icon: 'fa-solid fa-ticket', color: '#FFE082' },
                { id: 'other', name: '其他', icon: 'fa-solid fa-circle-info', color: '#B0BEC5' },
                { id: 'sightseeing', name: '景點', icon: 'fa-solid fa-camera', color: '#80CBC4' }
            ];
            
            const members = ['銘銘', '涵涵'];

            const generateDates = (startDateStr, daysCount) => {
                const start = new Date(startDateStr);
                const arr = [];
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                for(let i=0; i < daysCount; i++){
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    const full = d.toISOString().split('T')[0];
                    const m = d.getMonth() + 1;
                    const date = d.getDate();
                    const wd = days[d.getDay()];
                    arr.push({ full, display: `${m}/${date}`, weekday: `(${wd})` });
                }
                return arr;
            };

            const dates = computed(() => generateDates('2025-12-30', 7));
            const expenseDates = computed(() => generateDates('2025-12-29', 8));

            const fetchRates = async () => {
                try {
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                    const data = await res.json();
                    if(data && data.rates && data.rates.TWD) {
                        currentRate.value = data.rates.TWD;
                        isRateAuto.value = true;
                    }
                } catch(e) { console.log('Rate Error', e); }
            };

            const fetchWeather = async (lat = 43.06, lon = 141.35, locName = '札幌') => {
                try {
                    weatherData.value.location = locName;
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=precipitation_probability&forecast_days=1`);
                    const data = await res.json();
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    const hour = new Date().getHours();
                    const pop = data.hourly.precipitation_probability[hour] || 0;
                    
                    weatherData.value.temp = temp;
                    weatherData.value.pop = pop;
                    
                    let icon = ''; 
                    let desc = '';
                    if(code === 0) { icon='fa-solid fa-sun'; desc='晴朗'; }
                    else if(code <= 3) { icon='fa-solid fa-cloud-sun'; desc='多雲'; }
                    else if(code <= 48) { icon='fa-solid fa-smog'; desc='有霧'; }
                    else if(code <= 67) { icon='fa-solid fa-umbrella'; desc='下雨'; }
                    else if(code <= 77) { icon='fa-regular fa-snowflake'; desc='下雪'; }
                    else if(code <= 82) { icon='fa-solid fa-cloud-showers-heavy'; desc='陣雨'; }
                    else if(code <= 86) { icon='fa-solid fa-snowflake'; desc='陣雪'; }
                    else { icon='fa-solid fa-bolt'; desc='雷雨'; }
                    
                    weatherData.value.icon = icon;
                    weatherData.value.desc = desc;
                } catch(e) {
                    console.error("Weather Fetch Error", e);
                    weatherData.value.desc = '無法取得';
                }
            };

            const locateUser = () => {
                if (navigator.geolocation) {
                    weatherData.value.location = '定位中...';
                    navigator.geolocation.getCurrentPosition((pos) => {
                        fetchWeather(pos.coords.latitude, pos.coords.longitude, '目前位置');
                    }, () => {
                        weatherData.value.location = '定位失敗';
                        setTimeout(() => fetchWeather(43.06, 141.35, '札幌'), 2000);
                    });
                } else {
                    alert("瀏覽器不支援定位");
                }
            };

            const calculateCurrency = () => {
                if(!currencyInput.value || !currentRate.value) { currencyResult.value = 0; return; }
                currencyResult.value = Math.round(currencyInput.value * currentRate.value);
            };
            
            watch([currentRate, rateDirection, currencyInput], () => calculateCurrency());

            const toggleRateDirection = () => {
                rateDirection.value = !rateDirection.value;
            };

            const formatDateDisplay = (s, e) => {
                if(!s) return '';
                const format = (dStr) => dStr.slice(5).replace('-','/');
                return `${format(s)} - ${e ? format(e) : ''}`;
            };
            
            const calculateNights = (s, e) => {
                if(!s || !e) return 1;
                return Math.max(1, Math.floor((new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24)));
            };

            const uploadImg = (event, item) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        item.image = canvas.toDataURL('image/jpeg', 0.7);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            const openShopModal = () => {
                shopForm.value = { name: '', image: '' };
                editingShopIdx.value = -1;
                showShopModal.value = true;
            };

            const editShop = (idx) => {
                shopForm.value = { ...shoppingList.value[idx] };
                editingShopIdx.value = idx;
                showShopModal.value = true;
            };

            const saveShop = () => {
                if(shopForm.value.name) {
                    if(editingShopIdx.value > -1) {
                         shoppingList.value[editingShopIdx.value] = { ...shopForm.value };
                    } else {
                        shoppingList.value.push({...shopForm.value});
                    }
                    showShopModal.value = false;
                }
            };

            const deleteShop = () => {
                if(editingShopIdx.value > -1) {
                    shoppingList.value.splice(editingShopIdx.value, 1);
                    showShopModal.value = false;
                }
            };

            const openExpenseModal = () => {
                expenseForm.value = { title: '', amount: '', currency: 'JPY', category: 'food', method: 'Cash', payer: '銘銘', expenseType: 'shared' };
                editingExpenseIdx.value = -1;
                showExpenseModal.value = true;
            };

            const editExpense = (ex) => {
                const idx = expensesList.value.indexOf(ex);
                if (idx > -1) {
                    expenseForm.value = { ...ex }; 
                    editingExpenseIdx.value = idx; 
                    showExpenseModal.value = true;
                }
            };

            const saveExpense = () => {
                if(expenseForm.value.amount) {
                    if (editingExpenseIdx.value > -1) {
                        expensesList.value[editingExpenseIdx.value] = { ...expenseForm.value };
                    } else {
                        const selectedDateStr = expenseDates.value[selectedExpenseIndex.value].full;
                        expensesList.value.push({
                            ...expenseForm.value,
                            date: selectedDateStr 
                        });
                    }
                    showExpenseModal.value = false;
                }
            };

            const deleteExpense = () => {
                if (editingExpenseIdx.value > -1) {
                    expensesList.value.splice(editingExpenseIdx.value, 1);
                    showExpenseModal.value = false;
                }
            };

            const removeExpense = (item) => {
                const idx = expensesList.value.indexOf(item);
                if(idx > -1) expensesList.value.splice(idx, 1);
            };

            const getCategoryColor = (id) => {
                const map = { 'food': '#FFAB91', 'transport': '#90CAF9', 'hotel': '#CE93D8', 'shop': '#F48FB1', 'fun': '#FFE082', 'sightseeing': '#80CBC4', 'other': '#B0BEC5' };
                return map[id] || '#B0BEC5';
            };

            const getCategoryIcon = (id) => {
                const map = { 'food': 'fa-solid fa-utensils', 'transport': 'fa-solid fa-train-subway', 'hotel': 'fa-solid fa-hotel', 'shop': 'fa-solid fa-bag-shopping', 'fun': 'fa-solid fa-ticket', 'sightseeing': 'fa-solid fa-camera', 'other': 'fa-solid fa-circle-info' };
                return map[id] || 'fa-solid fa-circle';
            }

            const getTransportIcon = (type) => {
                const map = { 'car': 'fa-solid fa-car', 'train': 'fa-solid fa-train', 'subway': 'fa-solid fa-train-subway', 'bus': 'fa-solid fa-bus', 'walk': 'fa-solid fa-person-walking' };
                return map[type] || 'fa-solid fa-arrow-right';
            }

            const openMapLink = (query, url) => {
                if(url && url.trim() !== '') {
                    window.open(url, '_blank');
                } else {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
                }
            };
            
            const openSmartNavigation = (currentIndex) => {
                const currentItem = itineraryData.value[selectedDateIndex.value][currentIndex];
                const prevItem = itineraryData.value[selectedDateIndex.value][currentIndex - 1];
                const dest = currentItem.address || currentItem.name;
                const origin = prevItem ? (prevItem.address || prevItem.name) : '';
                if(!dest) return;
                let url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`;
                if(origin) { url += `&origin=${encodeURIComponent(origin)}`; }
                if(currentItem.transport === 'walk') url += '&travelmode=walking';
                else if(currentItem.transport === 'car') url += '&travelmode=driving';
                else url += '&travelmode=transit';
                window.open(url, '_blank');
            };
            
            const openNavigation = (destination) => {
                if(!destination) return;
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}`, '_blank');
            };

            const getDailyExpenses = (dateStr) => {
                return expensesList.value.filter(e => e.date === dateStr);
            };

            const getDailyTotal = (dateStr) => {
                const list = getDailyExpenses(dateStr);
                let sum = 0;
                let currencySymbol = '';
                if (rateDirection.value) {
                    currencySymbol = 'NT$';
                    list.forEach(e => {
                        if(e.currency === 'JPY') sum += Math.round(e.amount * currentRate.value);
                        else sum += Number(e.amount);
                    });
                } else {
                    currencySymbol = '¥';
                    list.forEach(e => {
                        if(e.currency === 'TWD') sum += Math.round(e.amount / currentRate.value);
                        else sum += Number(e.amount);
                    });
                }
                return `${currencySymbol} ${sum.toLocaleString()}`;
            };

            const calculateEndTime = () => {
                if(!itineraryForm.value.startTime || !itineraryForm.value.duration || itineraryForm.value.duration == 0) {
                    itineraryForm.value.endTime = '';
                    return;
                }
                const [h, m] = itineraryForm.value.startTime.split(':').map(Number);
                const d = new Date();
                d.setHours(h, m + parseInt(itineraryForm.value.duration));
                itineraryForm.value.endTime = d.toTimeString().slice(0, 5);
            };

            const addItineraryItem = () => {
                itineraryForm.value = { startTime: '09:00', duration: '0', endTime: '', name: '', location: '', address: '', note: '', category: 'sightseeing', transport: '', openHours: '', cost: '' };
                editingItineraryIdx.value = -1;
                showItineraryModal.value = true;
            };

            const editItinerary = (idx) => {
                const item = itineraryData.value[selectedDateIndex.value][idx];
                itineraryForm.value = JSON.parse(JSON.stringify(item));
                editingItineraryIdx.value = idx;
                showItineraryModal.value = true;
            };

            const saveItinerary = () => {
                if(!itineraryForm.value.name) return;
                const newItem = { ...itineraryForm.value, id: Date.now() };
                if(editingItineraryIdx.value > -1) {
                    itineraryData.value[selectedDateIndex.value][editingItineraryIdx.value] = newItem;
                } else {
                    itineraryData.value[selectedDateIndex.value].push(newItem);
                }
                itineraryData.value[selectedDateIndex.value].sort((a,b) => a.startTime.localeCompare(b.startTime));
                showItineraryModal.value = false;
            };

            const deleteItinerary = () => {
                if(editingItineraryIdx.value > -1) {
                    itineraryData.value[selectedDateIndex.value].splice(editingItineraryIdx.value, 1);
                    showItineraryModal.value = false;
                }
            };

            const totalExpenses = computed(() => {
                let jpySum = 0;
                let twdSum = 0;
                expensesList.value.forEach(e => {
                    if(e.currency === 'JPY') jpySum += Number(e.amount);
                    else twdSum += Number(e.amount);
                });
                let amount = 0;
                let currency = '';
                let label = '';
                if (rateDirection.value) {
                    amount = Math.round(twdSum + (jpySum * currentRate.value));
                    currency = 'TWD';
                    label = '折合新台幣總額';
                } else {
                    amount = Math.round(jpySum + (twdSum / currentRate.value));
                    currency = 'JPY';
                    label = '折合日幣總額';
                }
                return { amount, currency, label };
            });

            // 整合：共同筆記的變數與邏輯 (來自 app.js)
            const sharedNote = ref('');
            const DEBOUNCE_TIME = 1000;
            let DEBOUNCE_TIMER = null;
            let isUpdatingFromCloud = ref(false); 
            // 這裡使用一個固定的文件 ID，實務上可根據需求修改
            const SHARED_DOC_ID = 'hokkaido_2026_shared_notes';
            const LOCAL_DRAFT_KEY = 'hokkaido_2026_local_draft';

            // 🌟 新增：全資料同步的變數
            const TRIP_DATA_KEY = 'trip_data';
            let dataSyncDebounce = null;

            // 打包所有資料
            const getFullState = () => ({
                itinerary: JSON.parse(JSON.stringify(itineraryData.value)),
                expenses: JSON.parse(JSON.stringify(expensesList.value)),
                shopping: JSON.parse(JSON.stringify(shoppingList.value)),
                flights: JSON.parse(JSON.stringify(flights.value)),
                hotels: JSON.parse(JSON.stringify(hotels.value)),
                rate: currentRate.value
            });

            onMounted(() => {
                // ==========================================
                // 🌟 0. 必備工具函式 (修復資料結構與存檔)
                // ==========================================
                
                // 1. 定義存檔資料收集器 (解決存檔失敗問題)
                const getFullState = () => {
                    return {
                        itinerary: itineraryData.value,
                        expenses: expensesList.value,
                        shopping: shoppingList.value,
                        flights: flights.value,
                        hotels: hotels.value,
                        rate: currentRate.value
                    };
                };

                // 2. 定義結構修復器 (解決 12/31 跨年後無法新增行程的問題)
                const fixDataStructure = () => {
                    // 取得目前日期範圍需要的總天數，若無日期則預設 7 天
                    const requiredDays = (dates.value && dates.value.length > 0) ? dates.value.length : 7;
                    
                    // 如果資料根本不是陣列，初始化它
                    if (!Array.isArray(itineraryData.value)) {
                        itineraryData.value = Array(requiredDays).fill().map(() => []);
                    }

                    // 如果現有資料天數少於日期天數 (例如原本 5 天，改成 7 天)，補上空陣列
                    while (itineraryData.value.length < requiredDays) {
                        console.log("發現天數不足，自動補齊新的一天...");
                        itineraryData.value.push([]);
                    }

                    // 確保每一格都不是 undefined
                    for (let i = 0; i < requiredDays; i++) {
                        if (!itineraryData.value[i]) {
                            itineraryData.value[i] = [];
                        }
                    }
                };

                // 3. 獨立的本地資料載入函式 (解決訪客重整後資料消失)
                const loadLocalData = () => {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (parsed.itinerary) itineraryData.value = parsed.itinerary;
                            if (parsed.expenses) expensesList.value = parsed.expenses;
                            if (parsed.shopping) shoppingList.value = parsed.shopping;
                            if (parsed.flights) flights.value = parsed.flights;
                            if (parsed.hotels) hotels.value = parsed.hotels;
                            if (parsed.rate) currentRate.value = parsed.rate;
                            console.log("✅ 本地資料載入成功");
                        } catch (e) {
                            console.error("本地資料損毀，重置中...", e);
                        }
                    }
                    // 無論載入是否成功，都執行結構修復，確保不會報錯
                    fixDataStructure();
                };

                // ==========================================
                // 🌟 1. 初始化呼叫
                // ==========================================
                fetchRates();
                fetchWeather(); 
                calculateCurrency();
                
                // 🔥 關鍵修正：網頁一開啟，先嘗試載入本地資料 (讓訪客重整不會看到空白)
                loadLocalData();

                // 設定 Firebase 登入狀態持久化
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        console.log("Firebase Auth Persistence set to LOCAL success.");
                        startAuthListener();
                    })
                    .catch((error) => {
                         console.error("Error setting persistence:", error);
                         startAuthListener();
                    });

                // ==========================================
                // 🌟 2. 核心邏輯：資料同步與載入
                // ==========================================
                watch(isLoggedIn, (loggedIn) => {
                    if (loggedIn && isAuthorized.value) {
                        // A. 管理者登入：改用 Firebase 資料覆蓋本地資料
                        console.log("Auth User: Linking Firebase...");
                        const tripRef = database.ref(TRIP_DATA_KEY);
                        
                        // 下載資料
                        tripRef.on('value', (snapshot) => {
                            const data = snapshot.val();
                            if (data) {
                                isUpdatingFromCloud.value = true;
                                
                                // 載入行程並立即修復結構 (關鍵步驟)
                                if(data.itinerary) {
                                    itineraryData.value = data.itinerary;
                                }
                                // 每次從雲端載入後，都要修復結構 (解決日期擴充問題)
                                fixDataStructure();

                                if(data.expenses) expensesList.value = data.expenses;
                                if(data.shopping) shoppingList.value = data.shopping;
                                if(data.flights) flights.value = data.flights;
                                if(data.hotels) hotels.value = data.hotels;
                                if(data.rate) currentRate.value = data.rate;
                                
                                setTimeout(() => { isUpdatingFromCloud.value = false; }, 500);
                            } else {
                                // 雲端是空的，也要建立基礎結構
                                fixDataStructure(); 
                            }
                        });
                    } else {
                        // B. 未登入或訪客：確保使用本地資料
                        // 因為我們在 onMounted 一開始已經 loadLocalData() 過了，
                        // 這裡再次確認是為了防止登出後狀態未更新
                        console.log("Guest User: Keep using LocalStorage...");
                        if (itineraryData.value.length === 0) {
                            loadLocalData();
                             // 如果連本地都沒資料，塞入預設範例
                             if (itineraryData.value.length === 0) {
                                itineraryData.value = [
                                    [{ id: 1, startTime: '10:00', endTime: '11:00', name: '札幌電視塔', category: 'sightseeing', address: 'Sapporo TV Tower', note: '在大通公園東側', cost: '¥1000', transport: '', openHours: '09:00-22:00' }]
                                ];
                                fixDataStructure();
                             }
                        }
                    }
                });

                // ==========================================
                // 🌟 3. 監聽資料變更 (自動存檔)
                // ==========================================
                watch(
                    [itineraryData, expensesList, shoppingList, flights, hotels, currentRate],
                    () => {
                        // 如果是雲端更新觸發的，不要回寫 (避免無窮迴圈)
                        if (isUpdatingFromCloud.value) return;

                        // 1. 總是先備份到本地 (解決訪客重整資料消失問題)
                        const fullData = getFullState(); 
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));

                        // 2. 如果是管理者，才寫入 Firebase
                        if (isLoggedIn.value && isAuthorized.value) {
                            clearTimeout(dataSyncDebounce);
                            dataSyncDebounce = setTimeout(() => {
                                console.log("🚀 偵測到變更，正在同步至 Firebase...");
                                database.ref(TRIP_DATA_KEY).set(fullData)
                                    .then(() => console.log("✅ Firebase 同步成功"))
                                    .catch(err => {
                                        console.error("❌ Firebase 同步失敗:", err);
                                        // 如果是權限錯誤，提示使用者
                                        if (err.code === 'PERMISSION_DENIED') {
                                            alert("⚠️ 存檔失敗：沒有寫入權限 (Permission Denied)");
                                        }
                                    });
                            }, 500); // 0.5秒後存檔
                        }
                    },
                    { deep: true }
                );

                // ==========================================
                // 🌟 4. 共同筆記邏輯 (保持原樣)
                // ==========================================
                if (typeof database !== 'undefined') {
                    const noteRef = database.ref(`shared_notes/${SHARED_DOC_ID}`);
                    noteRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && data.content !== undefined) {
                            if (sharedNote.value !== data.content) {
                                isUpdatingFromCloud.value = true;
                                sharedNote.value = data.content;
                                setTimeout(() => { isUpdatingFromCloud.value = false; }, 100);
                            }
                        }
                    });
                    watch(sharedNote, (newValue) => {
                        if (isUpdatingFromCloud.value) return; 
                        clearTimeout(DEBOUNCE_TIMER);
                        DEBOUNCE_TIMER = setTimeout(() => {
                            if (isAuthorized.value) {
                                const userUID = auth.currentUser ? auth.currentUser.uid : 'guest';
                                noteRef.transaction((currentData) => {
                                    if (currentData === null) {
                                        return { content: newValue, version: 1, last_updated_by: userUID, timestamp: firebase.database.ServerValue.TIMESTAMP };
                                    }
                                    currentData.content = newValue;
                                    currentData.version = (currentData.version || 0) + 1;
                                    currentData.last_updated_by = userUID;
                                    currentData.timestamp = firebase.database.ServerValue.TIMESTAMP;
                                    return currentData;
                                });
                            } else {
                                localStorage.setItem(LOCAL_DRAFT_KEY, newValue);
                            }
                        }, DEBOUNCE_TIME);
                    });
                }
            });

            return { 
                currentTab, dates, selectedDateIndex, selectedExpenseIndex, hotels, flights, itineraryData, shoppingList, currencyInput, currencyResult, currentRate, rateDirection, showShopModal, showRateEditModal, showHotelEditModal, showFlightEditModal, showExpenseModal, showItineraryModal, shopForm, expensesList, expenseForm, itineraryForm, editingItineraryIdx, totalExpenses, categories, members, expenseDates, weatherData, isRateAuto, calculateCurrency, toggleRateDirection, calculateNights, formatDateDisplay, uploadImg, saveShop, saveExpense, removeExpense, getCategoryColor, getCategoryIcon, getTransportIcon, openMapLink, openNavigation, openSmartNavigation, getDailyExpenses, getDailyTotal, fetchWeather, locateUser, addItineraryItem, editItinerary, saveItinerary, deleteItinerary, calculateEndTime, editingShopIdx, openShopModal, editShop, deleteShop, editingExpenseIdx, openExpenseModal, editExpense, deleteExpense, isLoggedIn, handleLogin, statusMessage, handleLogout,
                sharedNote, isUpdatingFromCloud, isAuthorized, isAuthChecking, debugMsg
            };
        }
    }).mount('#app')
</script>
</body>
</html>